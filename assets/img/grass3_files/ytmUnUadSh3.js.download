;/*FB_PKG_DELIM*/

__d("MAWEBRestoreExtensionStep",["FBLogger","I64","MAWFetchMessagesForMLv2","MAWFetchMessagesFromEBForMLv2","MAWFindMsgsWithMinAndMaxTimestamp","MAWMessagesDirection","MAWMessagesRangesUtils","asyncToGeneratorRuntime","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.db,g=a.direction,i=a.logger,j=a.oldRange,k=a.oldRangeExternalIds;a=a.prevResponse;a=c("nullthrows")(a);f=(yield c("MAWFetchMessagesFromEBForMLv2")({chatJid:b,db:f,direction:g,logger:i,pageSize:e,range:j}));if(f.success===!1)return{extension:a,status:"complete"};i=(yield d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:b,direction:g,includeOriginalMsg:!1,pageSize:e,range:j}));if(i.success===!1){c("FBLogger")("messenger_web_product").mustfix("Failed to fetch messages from MAW after successful EB restore");return{extension:a,status:"complete"}}b=i.value;var l=f.value.recovered;e=l.messages;a=e.map(function(a){return a.sortOrderMs}).filter(Boolean);i=[Math.min.apply(Math,a),Math.max.apply(Math,a)];f=i[0];a=i[1];i=d("MAWMessagesDirection").getI64RangeTimestampForDirection(g,j);f=g==="desc"?[(h||(h=d("I64"))).of_float(f),i]:[i,(h||(h=d("I64"))).of_float(a)];var m=f[0],n=f[1];i=b.msgs.filter(function(a){return(h||(h=d("I64"))).ge((h||(h=d("I64"))).of_float(a.sortOrderMs),m)&&(h||(h=d("I64"))).le((h||(h=d("I64"))).of_float(a.sortOrderMs),n)});a=babelHelpers["extends"]({},b,{hasMoreAfter:b.hasMoreAfter||l.hasMoreAfter,hasMoreBefore:b.hasMoreBefore||l.hasMoreBefore,msgs:i});f=i.length===0||l.isEndOfCurrentFormat;if(!f)return{extension:a,status:"complete"};var o,p;if(i.length===0){c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: No local messages found within EB response range for protobuf. Filtered EB payload size: %s, original EB payload size: %s, original EB hasMoreBefore: %s, original EB hasMoreAfter: %s",e.length,l.messages.length,l.hasMoreBefore,l.hasMoreAfter);b=d("MAWFindMsgsWithMinAndMaxTimestamp").findEBMsgsWithMinAndMaxTimestamp(e);o=b[0];p=b[1]}else{f=d("MAWFindMsgsWithMinAndMaxTimestamp").findMsgsWithMinAndMaxTimestamp(i);o=f[0];p=f[1]}e=babelHelpers["extends"]({},j,function(){switch(g){case"asc":var a,b;a=(a=(a=p)==null?void 0:a.msgId)!=null?a:j.maxMessageId;b=(h||(h=d("I64"))).max(j.maxTimestampMs,((b=p)==null?void 0:b.sortOrderMs)!=null?(h||(h=d("I64"))).of_float((b=p)==null?void 0:b.sortOrderMs):j.maxTimestampMs);if(l.hasMoreAfter===!0){var e=!1;(h||(h=d("I64"))).equal(j.maxTimestampMs,b)&&j.maxMessageId===a?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same max timestamp: %s",(h||(h=d("I64"))).to_string(b)),e=!0,b=h.add(b,h.of_int32(1))):l.isEndOfCurrentFormat===!0&&(e=!0);e&&(b=(h||(h=d("I64"))).equal(b,(h||(h=d("I64"))).max_int)?b:(h||(h=d("I64"))).add(b,(h||(h=d("I64"))).of_int32(1)))}return{hasMoreAfter:l.hasMoreAfter,isLoadingAfter:!1,maxMessageId:a,maxTimestampMs:b};case"desc":b=(a=(e=o)==null?void 0:e.msgId)!=null?a:j.minMessageId;e=(h||(h=d("I64"))).min(j.minTimestampMs,((e=o)==null?void 0:e.sortOrderMs)!=null?(h||(h=d("I64"))).of_float((a=o)==null?void 0:a.sortOrderMs):j.minTimestampMs);if(l.hasMoreBefore===!0){a=!1;(h||(h=d("I64"))).equal(j.minTimestampMs,e)&&j.minMessageId===b?(c("FBLogger")("messenger_web_product").mustfix("EBMessageRangeDataSource: stuck in the same min timestamp: %s",(h||(h=d("I64"))).to_string(e)),a=!0):l.isEndOfCurrentFormat===!0&&(a=!0);a&&(e=(h||(h=d("I64"))).equal(e,(h||(h=d("I64"))).min_int)?e:(h||(h=d("I64"))).sub(e,(h||(h=d("I64"))).of_int32(1)))}return{hasMoreBefore:l.hasMoreBefore,isLoadingBefore:!1,minMessageId:b,minTimestampMs:e}}}());b=d("MAWMessagesRangesUtils").getNewMsgsRangesExternalIds(g,o,p,k);return{extension:a,status:"complete_with_range_override",updatedRange:e,updatedRangeExternalIds:b}});return function(b){return a.apply(this,arguments)}}();function a(a){var c=a.onEBFailure;return function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield i(a));if(a.status==="eb_failed"){c();return{extension:a.extension,status:"complete"}}return a});return function(b){return a.apply(this,arguments)}}()}g.createEBRestoreExtensionStep=a}),98);
__d("MAWLocalAndDeanonExtensionStep",["EBDeanonRangeExtension","MAWFetchMessagesForMLv2","MAWTimedBridge","Promise","WATagsLogger","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWMessageRangeDataSource: Failed to fetch messages from worker due to ",". Error: ",""]);i=function(){return a};return a}a=function(a){return function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var f=e.chatJid,g=e.count,j=e.db,k=e.direction,l=e.dispatch,m=e.logger,n=e.oldRange;e=e.oldRangeExternalIds;j=(yield (h||(h=b("Promise"))).all([a?d("EBDeanonRangeExtension").getRangeFromLocalDataIfConsistent({chatJid:f,db:j,direction:k,dispatch:l,logger:m,pageSize:g,range:n,rangeExternalIds:e,shouldInsertToLSDB:!1}):null,d("MAWFetchMessagesForMLv2").fetchMessagesFromMAW({chatJid:f,direction:k,includeOriginalMsg:!0,pageSize:g,range:n})]));l=j[0];e=j[1];if(e.success===!1){f=e.payload;k=f==null?"unknown":"["+f.name+"]: "+f.message;d("WATagsLogger").TAGS(["maw_message_core","MAWMessageRangeDataSource"]).ERROR(i(),e.error,k);if(e.payload instanceof d("MAWTimedBridge").MAWBridgeTimeoutError)return{status:"try_again"};throw(g=e.payload)!=null?g:c("err")("Failed to fetch messages from worker")}if(l!=null){a&&(m==null?void 0:m.addQPLAnnotations({string:{eb_restore_status:"skipped"}}));return{extension:e.value,status:"complete"}}return{extension:e.value,status:"continue"}});return function(a){return e.apply(this,arguments)}}()};e=a;g["default"]=e}),98);
__d("MAWMediaUIConverter",["MAWBridgeNewMediaHandler","MAWBridgeTypesCreators","MAWMediaUtils","MAWRavenUtils","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=d("WAJids").unsafeCoerceToChatJid("placeholder");function i(a){return d("MAWBridgeTypesCreators").createBridgeMedia(a)}function j(a,b,c){var e=d("MAWMediaUtils").createHdTypesForBridgeMedia([c]);return i({chatJid:h,filteredMsgIds:[c.msgId],hasMediaForUI:b,hdTypes:e,media:a,ravenSettings:c.ravenEphemeralType!=null&&c.ravenEphemeralMediaState!=null?d("MAWRavenUtils").deriveRavenSettings(c.ravenEphemeralType,c.ravenEphemeralMediaState):null,sortOrderMs:d("WATimeUtils").castToMillisTime(c.sortOrderMs!=null?c.sortOrderMs:c.ts*1e3)})}function k(a,b,c){var e=b.mediaId,f=b.offlineAttachmentId,g=b.plaintextHash;e=d("MAWBridgeNewMediaHandler").getAttachmentID(e,g);return d("MAWBridgeNewMediaHandler").getAttachmentFromBridgeMedia(null,b,c,e,(g=f)!=null?g:e,a)}function a(a,b,c,d){if(d==null)return;d=j(d,b,c);if(d==null)return;return k(a,d,c.msgId)}g.bridgeToLS=k;g.mawToLS=a}),98);
__d("MAWMessageUIConverter",["I64","MAWAdminMsgCTA","MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeNewMsgHandler","MAWMsgReplySnippet"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return d("MAWBridgeMsg").createBridgeMsg(a,void 0,b,void 0)}function j(a){return{ctaType:d("MAWAdminMsgCTA").getCtaTypeByAdminType(a.adminType),title:d("MAWAdminMsgCTA").getAdminMsgCTAContentByAdminType(a.adminType).title}}function a(a,b,c){c=i(b,c);a=d("MAWBridgeNewMsgHandler").composeMessage(a,c,j(c),d("MAWMsgReplySnippet").getReplySnippet(c));if(b.ephemeralCounterStarted===!0){c=d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown([b]);b=c.msgs.length===1?c.msgs[0]:void 0;if(b!=null)return babelHelpers["extends"]({},a,{ephemeralExpirationTs:(h||(h=d("I64"))).of_float(b.countdownTs)})}return a}g.getAdminMsgCTA=j;g.mawToLS=a}),98);
__d("MAWReactionUIConverter",["MAWBridgeReactionUpsertHandler","MAWBridgeTypesCreators"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null||c==null)return;return d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a})}function i(a,b){var c=a.actorId,e=a.messageId,f=a.reaction;a=a.ts;return d("MAWBridgeReactionUpsertHandler").composeReaction(c,b,e,a,f)}function a(a,b){a=h(a);if(a==null)return;return i(a,b)}g.bridgeToLS=i;g.mawToLS=a}),98);
__d("MAWXMAUIConvertor",["I64","MAWBridgeXMA","MAWBridgeXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c,e,f){var g=f.attachmentCta1,h=f.attachmentCta2,i=f.attachmentCta3;f=f.defaultCta;return d("MAWBridgeXMAUtils").composeAttachmentXMA(a,e,b,c,g==null?void 0:g.ctaId,h==null?void 0:h.ctaId,i==null?void 0:i.ctaId,f==null?void 0:f.ctaId,"MAWXMAUIConvertor")}function j(a,b,c,e){var f=a.ctas,g=a.defaultCTA,i=a.xmaId,j=d("MAWBridgeXMAUtils").maybeBridgeToLSTargetId(a.targetId),k=(h||(h=d("I64"))).of_int32(i),l={};g!=null&&(l.defaultCta=d("MAWBridgeXMAUtils").composeDefaultAttachmentCta(g,k,c,e,b,j,a.targetType));i=d("MAWBridgeXMAUtils").createBlobCtaAttachment(k,a,c,e,b);g=i.blobCtaAttachment;if(g!=null){l.attachmentCta1=g;return l}f!=null&&f.map(function(a,f){var g=d("MAWBridgeXMAUtils").getCtaIdFromDefaultCtaId(k,f);a=d("MAWBridgeXMAUtils").composeAttachmentCta(a,g,c,e,b,j);f===0?l.attachmentCta1=a:f===1?l.attachmentCta2=a:f===2&&(l.attachmentCta3=a)});return l}function a(a,b,c,e,f){b=d("MAWBridgeXMA").createBridgeXMA(b,f,{hasMedia:a,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1});f=String(b.xmaId);a=j(b,f,c,e);b=i(b,f,c,e,a);return{attachment:b,attachmentCTAs:a}}g.bridgeXMAtoLSAttachment=i;g.bridgeXMAtoLSAttachmentCTAs=j;g.mawToLS=a}),98);
__d("MAWRangeExtensionDataConverter",["I64","MAWBridgeNewMsgHandler","MAWBridgeNewReceiverFetchInfoHandler","MAWDbMsg","MAWMediaUIConverter","MAWMessageUIConverter","MAWMsg","MAWMsgReplySnippet","MAWReactionUIConverter","MAWXMAUIConvertor","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){var e=b.msgs,f=b.reactions,g=b.medias,i=b.expiringCountdown,j=b.xmas,k=b.receiverFetchInfoPayloads;return e.map(function(b){var e,l=d("MAWBridgeNewMsgHandler").composeMessage(a,b,d("MAWMessageUIConverter").getAdminMsgCTA(b),d("MAWMsgReplySnippet").getReplySnippet(b));b=i.find(function(a){return a.msgId===l.messageId});b!=null&&(l=babelHelpers["extends"]({},l,{ephemeralExpirationTs:(h||(h=d("I64"))).of_float(b.countdownTs)}));b=(b=c("qex")._("1599"))!=null?b:!1;if(!b)return{associatedData:{attachmentData:{attachmentCTAs:[],attachmentItems:[],attachments:[]},reactions:[]},message:l};b=f.filter(function(a){return a.type==="upsert"}).filter(function(a){return a.reaction.messageId===l.messageId}).map(function(b){b=b.reaction;return d("MAWReactionUIConverter").bridgeToLS(b,a)});var m=c("nullthrows")(d("MAWDbMsg").toMsgId(l.messageId)),n=[],o=[];if(d("MAWMsg").isXMAMsg(l)&&((e=c("qex")._("1595"))!=null?e:!1)){e=j.find(function(a){return a.msgId===m});if(e){var p=String(e.xmaId),q=d("MAWXMAUIConvertor").bridgeXMAtoLSAttachmentCTAs(e,p,m,a);e=d("MAWXMAUIConvertor").bridgeXMAtoLSAttachment(e,p,m,a,q);o=[q];n=[e]}}else d("MAWMsg").isReceiverFetchMsg(l)?n=k.filter(function(a){return a.msgId===m}).map(function(b){return d("MAWBridgeNewReceiverFetchInfoHandler").composeAttachment(b,a,null)}):d("MAWMsg").isMediaMsg(l)&&(n=g.filter(function(a){return a.msgIds.indexOf(m)!==-1}).map(function(b){return d("MAWMediaUIConverter").bridgeToLS(a,b,m)}));return{associatedData:{attachmentData:{attachmentCTAs:o,attachmentItems:[],attachments:n},reactions:b},message:l}})}g.convertLocalResponseToMessages=a}),98);
__d("MpsOverBridge",["MAWBridgeSendAndReceive"],(function(a,b,c,d,e,f,g){"use strict";var h=function(){this.loadMessage=function(a){return d("MAWBridgeSendAndReceive").sendAndReceive("mps","mpsLoadMessage",a)},this.loadMessages=function(a){return d("MAWBridgeSendAndReceive").sendAndReceive("mps","mpsLoadMessages",a)}},i;function a(){i==null&&(i=new h());return i}g.mps=a}),98);
__d("MpsLoadMessagesStep",["I64","MAWMessagesDirection","MpsMessageToBridge","MpsOverBridge","MpsTypes","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.count,f=a.direction,g=a.logger,i=a.oldRange;a=a.oldRangeExternalIds;g==null?void 0:g.addQPLAnnotations({bool:{use_mps:!0}});var j=[d("MpsTypes").toTimestamp((h||(h=d("I64"))).to_float(d("MAWMessagesDirection").getI64RangeTimestampForDirection(f,i))),d("MpsTypes").toMessageId(d("MAWMessagesDirection").getRangeMsgIdForDirection(f,i))];g==null?void 0:g.markQPLPoint("mps_load_messages_start");j=(yield d("MpsOverBridge").mps().loadMessages({direction:f,from:j,numMessages:e,threadId:d("MpsTypes").toThreadId(b)}));if(j.success===!1){g==null?void 0:g.markQPLPoint("mps_load_messages_failure");throw c("err")("Failed to fetch messages from MPS")}else{e=d("MAWMessagesDirection").switchOnMWPMessagesDirection(f,{asc:j.value.cursorInfo.hasNext,desc:j.value.cursorInfo.hasPrevious});b=d("MAWMessagesDirection").switchOnMWPMessagesDirection(f,{asc:j.value.cursorInfo.hasPrevious,desc:j.value.cursorInfo.hasNext});var k={editMsgHistory:[],expiringCountdown:[],hasMoreAfter:e,hasMoreBefore:b,medias:[],msgs:j.value.messages.map(function(a){a=d("MpsMessageToBridge").mpsMessagetoBridge(a.toplevelProtobuf);if((a==null?void 0:a.kind)==="bridgeMsg")return a.value}).filter(Boolean),polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]},l=i,m=a;j=j.value.cursorInfo.endCursor;j!=null?(l=babelHelpers["extends"]({},i,d("MAWMessagesDirection").switchOnMWPMessagesDirection(f,{asc:{hasMoreAfter:e,isLoadingAfter:!1,maxMessageId:d("MpsTypes").fromMessageId(j[1]),maxTimestampMs:(h||(h=d("I64"))).of_float(j[0])},desc:{hasMoreBefore:b,isLoadingBefore:!1,minMessageId:d("MpsTypes").fromMessageId(j[1]),minTimestampMs:h.of_float(j[0])}})),m=d("MAWMessagesDirection").switchOnMWPMessagesDirection(f,{asc:{maxExternalId:d("MpsTypes").fromMessageId(j[1]),minExternalId:a.minExternalId},desc:{maxExternalId:a.maxExternalId,minExternalId:d("MpsTypes").fromMessageId(j[1])}})):l=babelHelpers["extends"]({},i,d("MAWMessagesDirection").switchOnMWPMessagesDirection(f,{asc:{hasMoreAfter:e,isLoadingAfter:!1},desc:{hasMoreBefore:b,isLoadingBefore:!1}}));g==null?void 0:g.markQPLPoint("mps_load_messages_end");return{extension:k,status:"complete_with_range_override",updatedRange:l,updatedRangeExternalIds:m}}});return i.apply(this,arguments)}g.MpsLoadMessagesStep=a}),98);
__d("MAWMessageRangeDataSourceV2",["FBLogger","I64","LSDatabaseSingleton","LSEncryptedBackupsBackupTenancy","LSIntEnum","MAWEBRestoreExtensionStep","MAWEncryptedBackupUtils","MAWLocalAndDeanonExtensionStep","MAWMessageIntegrityEBFetchStatus","MAWMessageRangeDataExternalObservables","MAWMessagesPaginationUtils","MAWMessagesRangesUtils","MAWMpsGating","MAWPutMessagesToDB","MAWRangeExtensionDataConverter","MAWWaitForACTThreadReadyForMLv2","MLV2DataSourceLogger","MLV2RangeExtensionLogger","MessageRangeSet","MpsLoadMessagesStep","Promise","ReQL","ReQLObservable","asyncToGeneratorRuntime","err","gkx","nullthrows","switchMap"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=5,m=function(){function a(a,e){var f=this;this.$2=new(d("MessageRangeSet").MessageRangeSet)();this.$3=l;this.$4=!0;this.$5=new(d("MAWMessageRangeDataExternalObservables").MAWMessageRangeDataExternalObservables)();this.getOrCreateMessageRangeCoveringCursor=function(a,b,c){b==null?void 0:b.annotateMessageRangesDataSource("MAWMessageRangeDataSourceV2");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_start");c=f.$2.getRangeForTimestamp(a.timestampMs);if(c!=null){b==null?void 0:b.markQPLPoint("maw_preexisting_range");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");var e={maxExternalId:null,minExternalId:null};return f.$5.getOrCreateExternalObservableForRange(c,e)}c=(k||(k=d("I64"))).equal(a.timestampMs,k.max_int);e={hasMoreAfter:!c,hasMoreBefore:!0,isLoadingAfter:!1,isLoadingBefore:!1,maxMessageId:(e=a.messageId)!=null?e:"",maxTimestampMs:a.timestampMs,minMessageId:(c=a.messageId)!=null?c:"",minTimestampMs:a.timestampMs,threadKey:f.$1};c=f.$2.upsertRange(e);b==null?void 0:b.markQPLPoint("maw_range_created");b==null?void 0:b.markQPLPoint("maw_get_or_create_range_end");return f.$5.getOrCreateExternalObservableForRange(c,{maxExternalId:a==null?void 0:a.externalId,minExternalId:a==null?void 0:a.externalId})};this.$6=function(a){var b=d("MLV2DataSourceLogger").getMLV2LoggerForThread(f.$1,a),c=d("MLV2RangeExtensionLogger").getRangeExtensionLoggerForThread(f.$1,a);a={addQPLAnnotations:function(a){b==null?void 0:b.addQPLAnnotations(a),c==null?void 0:c.addQPLAnnotations(a)},annotateMessageRangesDataSource:function(a){b==null?void 0:b.annotateMessageRangesDataSource(a),c==null?void 0:c.annotateMessageRangesDataSource(a)},getInstanceKey:function(){var a;return(a=b==null?void 0:b.getInstanceKey())!=null?a:0},markQPLCancel:function(a){b==null?void 0:b.markQPLCancel(a),c==null?void 0:c.markQPLCancel(a)},markQPLFailure:function(a){b==null?void 0:b.markQPLFailure(a),c==null?void 0:c.markQPLFailure(a)},markQPLFailureWithMsg:function(a){b==null?void 0:b.markQPLFailureWithMsg(a),c==null?void 0:c.markQPLFailureWithMsg(a)},markQPLPoint:function(a,d){b==null?void 0:b.markQPLPoint(a,d),c==null?void 0:c.markQPLPoint(a,d)},markQPLSuccess:function(a){b==null?void 0:b.markQPLSuccess(a),c==null?void 0:c.markQPLSuccess()}};return a};this.extendRange=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,g,i){var j=f.$6(e);j==null?void 0:j.annotateMessageRangesDataSource("MAWMessageRangeDataSourceV2");j==null?void 0:j.markQPLPoint("maw_v2_extend_range_start");var l=f.$2.getRangeForTimestamp(a.minTimestampMs);if(l==null){j==null?void 0:j.markQPLPoint("extend_range_invalid");return(h||(h=b("Promise"))).resolve()}var m=l.value;a=(yield d("MAWMessagesPaginationUtils").getMessagesRangesV2ExternalIdsIfChanged(a,m,c));if(e==="asc"&&(!m.hasMoreAfter||m.isLoadingAfter)){j==null?void 0:j.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}if(e==="desc"&&(!m.hasMoreBefore||m.isLoadingBefore)){j==null?void 0:j.markQPLPoint("extend_range_skipped");return(h||(h=b("Promise"))).resolve()}c=f.$5.getOrCreateExternalObservableForRange(l,a);c.next({range:babelHelpers["extends"]({},m,{isLoadingAfter:m.isLoadingAfter||e==="asc",isLoadingBefore:m.isLoadingBefore||e==="desc"}),rangeExternalIds:a,type:"range_only"});var n={maxMessageId:l.value.maxMessageId,maxTimestampMs:l.value.maxTimestampMs,minMessageId:l.value.minMessageId,minTimestampMs:l.value.minTimestampMs};return f.$7(l.value,a,c,e,g,i).then(function(){var a=(k||(k=d("I64"))).equal(n.maxTimestampMs,l.value.maxTimestampMs)&&(k||(k=d("I64"))).equal(n.minTimestampMs,l.value.minTimestampMs)&&l.value.maxMessageId===n.maxMessageId&&l.value.minMessageId===n.minMessageId;j==null?void 0:j.addQPLAnnotations({bool:{extended_range_is_identical:a}})})["catch"](function(a){j==null?void 0:j.markQPLPoint("extend_range_failed");j==null?void 0:j.addQPLAnnotations({string:{range_extension_error:a instanceof Error?a.message:"unknown_error"}});throw a})});return function(b,c,d,e,f){return a.apply(this,arguments)}}();this.$7=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,j,k,l){var m=(yield (i||(i=d("LSDatabaseSingleton"))).LSDatabaseSingleton),n=f.$6(j);n==null?void 0:n.markQPLPoint("maw_wait_act_thread_start");var o=(yield d("MAWWaitForACTThreadReadyForMLv2").waitForACTThreadReadyForMLv2(m.tables,f.$1,"MAWMessageRangeDataSourceV2",n));o=o.chatJid;n==null?void 0:n.markQPLPoint("maw_wait_act_thread_end");var p=d("MAWMpsGating").isFullMpsEnabled()?f.$8():[{name:"deanon_and_local_fetch",step:c("MAWLocalAndDeanonExtensionStep")(f.$4&&f.isEBEnabled)},{name:"eb_restore",step:d("MAWEBRestoreExtensionStep").createEBRestoreExtensionStep({onEBFailure:function(){f.$4=!1,d("MAWMessageIntegrityEBFetchStatus").recordEBFailure(f.$1)}})},{name:"fallback",step:function(a){a=a.prevResponse;return(h||(h=b("Promise"))).resolve({extension:c("nullthrows")(a),status:"complete"})}}],q=null;for(p of p){var r=p.name,s=p.step;s=(yield f.$9(s,r,{chatJid:o,count:k,db:m,direction:j,dispatch:l,logger:n,oldRange:a,oldRangeExternalIds:e,prevResponse:q},g));if(s.shouldTerminate)return;q=s.extension}});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}();this.$9=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,g){var h=e.db,i=e.direction,j=e.dispatch,k=e.logger,l=e.oldRange,m=e.oldRangeExternalIds;k==null?void 0:k.markQPLPoint("maw_range_"+b+"_start");a=(yield a(e));k==null?void 0:k.markQPLPoint("maw_range_"+b+"_end");if(a.status==="try_again"){k==null?void 0:k.markQPLPoint("maw_range_"+b+"_retry");if(c("gkx")("7409")&&f.$3>0){k==null?void 0:k.markQPLPoint("maw_range_"+b+"_timed_out");f.$3-=1;g.next({range:babelHelpers["extends"]({},l,{isLoadingAfter:!1,isLoadingBefore:!1}),rangeExternalIds:m,type:"range_only"});return{shouldTerminate:!0}}throw c("err")("Timed out for step: "+b)}if(a.status==="complete"){k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(h,a.extension,j,k==null?void 0:k.getInstanceKey());k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end");k==null?void 0:k.markQPLPoint("maw_upsert_range_start");f.$10(l,m,g,i,a.extension);k==null?void 0:k.markQPLPoint("maw_upsert_range_end");return{shouldTerminate:!0}}if(a.status==="complete_with_range_override"){k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_start");yield d("MAWPutMessagesToDB").insertMessageResponseIntoDatabase(h,a.extension,j,k==null?void 0:k.getInstanceKey());k==null?void 0:k.markQPLPoint("insert_msgs_to_lsdb_end");k==null?void 0:k.markQPLPoint("maw_upsert_range_start");f.$11(g,a.updatedRange,a.updatedRangeExternalIds);k==null?void 0:k.markQPLPoint("maw_upsert_range_end");return{shouldTerminate:!0}}return{extension:a.extension,shouldTerminate:!1}});return function(b,c,d,e){return a.apply(this,arguments)}}();this.$10=function(a,b,c,e,g){b=d("MAWMessagesRangesUtils").mergeMoreMessagesResponseIntoRange(a,b,g,e);e=b[0];b=b[1];g=d("MAWRangeExtensionDataConverter").convertLocalResponseToMessages(f.$1,g);a=(k||(k=d("I64"))).equal(a.minTimestampMs,a.maxTimestampMs)&&a.maxMessageId===a.minMessageId;f.$11(c,e,b,{coverEntireRange:a,messages:g})};this.truncateMessageRange=function(a){};this.$1=a;this.isEBEnabled=e}var e=a.prototype;e.$8=function(){return[{name:"mps_load_messages",step:d("MpsLoadMessagesStep").MpsLoadMessagesStep},{name:"fallback",step:function(a){a=a.prevResponse;return(h||(h=b("Promise"))).resolve({extension:c("nullthrows")(a),status:"complete"})}}]};e.$11=function(a,b,c,d){b=this.$2.upsertRange(b);d!=null?a.next({prefetchedData:d,range:b.value,rangeExternalIds:c,type:"range_with_prefetched_messages"}):a.next({range:b.value,rangeExternalIds:c,type:"range_only"})};return a}(),n=function(){function a(a){var b=this;this.$1=new Map();this.getOrCreateMessageRangeCoveringCursor=function(a,d,e){var f=a.threadKey;return c("switchMap")(b.$2,function(c){return b.$3(f,c).getOrCreateMessageRangeCoveringCursor(a,d,e)})};this.extendRange=function(a,e,f,g,h){var i=a.threadKey,j=d("MLV2RangeExtensionLogger").startRangeExtensionLoggerForThread(i,f,a,g);return c("nullthrows")(b.$1.get((k||(k=d("I64"))).to_string(i))).extendRange(a,e,f,g,h).then(function(){j.markQPLSuccess()})["catch"](function(a){j.markQPLFailure(a);throw a})};this.truncateMessageRange=function(a){b.$1["delete"]((k||(k=d("I64"))).to_string(a))};this.$2=d("ReQLObservable").create(a,function(){return d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state).take(1).map(function(a){var b=d("MAWEncryptedBackupUtils").getBackupTenancyFromClientStateRow(a);b!=null&&a.backupTenancy==null&&c("FBLogger")("messenger_web_product").warn("Previously broken state of invalid backup tenancy is caught");return b!=null&&(k||(k=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION))})}).map(function(a){return Boolean(a==null?void 0:(a=a[0])==null?void 0:a[1])})}var b=a.prototype;b.$3=function(a,b){var e=(k||(k=d("I64"))).to_string(a);if(!this.$1.has(e)){var f=new m(a,b);this.$1.set(e,f)}f=c("nullthrows")(this.$1.get(e));f.isEBEnabled!==b&&(f=new m(a,b),this.$1.set(e,f));return f};return a}(),o,p;function a(a){(o==null||p!==a)&&(p=a,o=new n(a));return o}g["default"]=a}),98);